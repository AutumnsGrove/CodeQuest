#!/bin/bash
# Pre-commit hook for CodeQuest - Go project
# Runs code quality checks on staged Go files
# - gofmt: Go code formatting
# - go vet: Go code analysis
# - go test: Run tests on modified packages
# - Prevent committing secrets/API keys

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}CodeQuest Pre-Commit Checks${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Get staged Go files
go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

# Track if any checks fail
checks_failed=0

# ============================================================================
# SECRETS SCANNING
# ============================================================================
echo -e "${YELLOW}Scanning for secrets and sensitive data...${NC}"

# Patterns to detect actual API keys (not documentation references)
PATTERNS=(
    "sk-ant-api[0-9a-zA-Z\-]+"          # Anthropic keys (actual keys)
    "sk-[a-zA-Z0-9]{32,}"               # OpenAI/OpenRouter keys (actual)
    "AIza[0-9A-Za-z\-_]{35}"            # Google API keys (actual)
    "AKIA[0-9A-Z]{16}"                  # AWS Access Keys (actual)
)

# Check for actual secrets in committed code (not documentation)
secrets_found=0
for pattern in "${PATTERNS[@]}"; do
    # Look for actual key patterns that appear to be real (not in quotes or backticks)
    # Only check added lines that contain the pattern
    if git diff --cached | grep "^+" | grep -E "$pattern" | grep -v "^+++" | grep -vE "['\"\`#]" > /dev/null 2>&1; then
        echo -e "${RED}✗ SECURITY WARNING: Possible API key detected!${NC}"
        echo -e "${YELLOW}Pattern: $pattern${NC}"
        echo ""
        echo -e "${YELLOW}Suspicious additions:${NC}"
        git diff --cached | grep "^+" | grep -E "$pattern" | grep -v "^+++" | head -5
        echo ""
        secrets_found=1
        checks_failed=1
        break
    fi
done

# Also check if secrets files are being committed directly
if git diff --cached --name-only | grep -qE "secrets\.json|credentials\.json|\.env$|\.aws/|\.ssh/" 2>/dev/null; then
    echo -e "${RED}✗ SECURITY WARNING: Sensitive files detected!${NC}"
    echo -e "${YELLOW}Don't commit: secrets.json, credentials.json, .env, .aws/, .ssh/${NC}"
    echo ""
    echo -e "${YELLOW}Files being committed:${NC}"
    git diff --cached --name-only | grep -E "secrets\.json|credentials\.json|\.env$|\.aws/|\.ssh/" | sed 's/^/  - /'
    echo ""
    secrets_found=1
    checks_failed=1
fi

if [ $secrets_found -eq 0 ]; then
    echo -e "${GREEN}✓ No secrets detected${NC}"
fi

echo ""

# Skip remaining checks if no Go files staged
if [ -z "$go_files" ]; then
    echo -e "${YELLOW}No Go files to check${NC}"

    if [ $checks_failed -eq 0 ]; then
        echo ""
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
        echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        exit 0
    else
        echo ""
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        echo -e "${RED}Pre-commit checks failed!${NC}"
        echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
        exit 1
    fi
fi

echo -e "${YELLOW}Checking staged Go files:${NC}"
echo "$go_files" | sed 's/^/  /'
echo ""

# ============================================================================
# GO FORMAT CHECK (gofmt)
# ============================================================================
echo -e "${YELLOW}Running gofmt formatting check...${NC}"

# Check if go is installed
if ! command -v go &> /dev/null; then
    echo -e "${RED}✗ Go is not installed${NC}"
    checks_failed=1
else
    # Check formatting
    unformatted_files=0
    for file in $go_files; do
        if ! gofmt -l "$file" 2>/dev/null | grep -q "^$"; then
            echo -e "${YELLOW}  - $file needs formatting${NC}"
            unformatted_files=$((unformatted_files + 1))
        fi
    done

    if [ $unformatted_files -eq 0 ]; then
        echo -e "${GREEN}✓ All files properly formatted${NC}"
    else
        echo -e "${RED}✗ $unformatted_files file(s) need formatting${NC}"
        echo ""
        echo -e "${YELLOW}To fix: gofmt -w <file> or use 'go fmt ./...'${NC}"
        checks_failed=1
    fi
fi

echo ""

# ============================================================================
# GO VET CHECK (static analysis)
# ============================================================================
echo -e "${YELLOW}Running go vet static analysis...${NC}"

# Get list of affected packages
affected_packages=$(echo "$go_files" | xargs -I {} dirname {} | sort -u)

vet_failed=0
for pkg_dir in $affected_packages; do
    if [ ! -f "$pkg_dir/go.mod" ]; then
        # Not a module root, use relative path
        if ! go vet "./$pkg_dir" 2>&1; then
            echo -e "${RED}✗ go vet failed in $pkg_dir${NC}"
            vet_failed=1
        fi
    fi
done

# Also run on module root
if ! go vet ./... 2>&1 | grep -v "no Go files" > /tmp/vet_output.txt 2>&1; then
    if [ -s /tmp/vet_output.txt ]; then
        echo -e "${RED}✗ go vet found issues:${NC}"
        cat /tmp/vet_output.txt | sed 's/^/  /'
        vet_failed=1
    fi
fi

if [ $vet_failed -eq 0 ]; then
    echo -e "${GREEN}✓ go vet analysis passed${NC}"
else
    checks_failed=1
fi

echo ""

# ============================================================================
# GO TEST CHECK (run tests for affected packages)
# ============================================================================
echo -e "${YELLOW}Running tests for affected packages...${NC}"

test_failed=0
for pkg_dir in $affected_packages; do
    # Only run tests if this package has test files
    if ls "$pkg_dir"/*_test.go > /dev/null 2>&1; then
        echo -e "${YELLOW}  Testing $pkg_dir...${NC}"
        if ! go test "./$pkg_dir" -v 2>&1 | tail -5; then
            echo -e "${RED}✗ Tests failed in $pkg_dir${NC}"
            test_failed=1
            checks_failed=1
        else
            echo -e "${GREEN}  ✓ $pkg_dir tests passed${NC}"
        fi
    fi
done

if [ $test_failed -eq 0 ] && [ ! -z "$affected_packages" ]; then
    echo -e "${GREEN}✓ All affected package tests passed${NC}"
fi

echo ""

# ============================================================================
# FINAL RESULTS
# ============================================================================
if [ $checks_failed -eq 1 ]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}Pre-commit checks failed!${NC}"
    echo -e "${RED}Please fix the issues above before committing.${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}To bypass hooks (use sparingly):${NC}"
    echo "  git commit --no-verify -m 'Your message'"
    exit 1
else
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 0
fi
